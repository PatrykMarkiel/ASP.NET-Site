@using WebApplication3.Models.ViewModel;
@model IEnumerable<MeasurementVm>

@{
    ViewData["Title"] = "Measurement Chart";

    var uniqueTreatmentDates = Model.Select(m => m.TreatmentTime.Date).Distinct().OrderBy(d => d).ToList();

    var xValues = new List<string>();
    foreach (var date in uniqueTreatmentDates)
    {
        xValues.Add(date.ToString("yyyy-MM-dd"));
    }

    var datasets = new List<object>();
    var random = new Random();

    var measurementNames = Model.Select(m => m.MeasurementName).Distinct().ToList();
    foreach (var measurementName in measurementNames)
    {
        if (measurementName != null && measurementName.ToString() != "Observation")
        {
            var dataValues = new List<double?>();

            foreach (var date in uniqueTreatmentDates)
            {
                var measurementForDate = Model.FirstOrDefault(m => m.MeasurementName == measurementName && m.TreatmentTime.Date == date);

                if (measurementForDate != null)
                {
                    dataValues.Add(measurementForDate.Value ?? 0);
                }
                else
                {
                    dataValues.Add(null);
                }
            }

            var randomColor = String.Format("#{0:X6}", random.Next(0x1000000));

            datasets.Add(new
            {
                label = measurementName.ToString(),
                data = dataValues,
                borderColor = randomColor,
                fill = false
            });
        }
    }
}

<canvas id="myChart" style="width:100%;max-width:1200px"></canvas>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/Chart.min.js"></script>

    <script>
        var xValues = @Html.Raw(Json.Serialize(xValues));

        var chartData = {
            labels: xValues,
            datasets: @Html.Raw(Json.Serialize(datasets))
                };

        new Chart("myChart", {
            type: "line",
            data: chartData,
            options: {
                legend: { display: true },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Treatment Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    </script>
}
