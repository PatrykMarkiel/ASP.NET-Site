@using WebApplication3.Models.ViewModel;
@model IEnumerable<MeasurementVm>

@{
    ViewData["Title"] = "Measurement Chart";

    var uniqueMeasurementNames = Model.Select(m => m.MeasurementName).Distinct().Where(measurementName => measurementName.ToString() != "Observation").ToList();

    var random = new Random();
}

@foreach (var measurementName in uniqueMeasurementNames)
{
    var dataValues = new List<double?>();
    var measurementData = Model.Where(m => m.MeasurementName == measurementName).OrderBy(m => m.TreatmentTime.Date).ToList();

    var xValues = measurementData.Select(m => m.TreatmentTime.Date.ToString("yyyy-MM-dd")).Distinct().OrderBy(d => d).ToList();

    foreach (var date in xValues)
    {
        var measurementForDate = measurementData.FirstOrDefault(m => m.TreatmentTime.Date.ToString("yyyy-MM-dd") == date);

        if (measurementForDate != null)
        {
            dataValues.Add(measurementForDate.Value ?? 0);
        }
        else
        {
            dataValues.Add(null);
        }
    }

    var randomColor = String.Format("#{0:X6}", random.Next(0x1000000));

    <canvas id="@("myChart_" + measurementName)" style="width:100%;max-width:800px"></canvas>

    <script>
        var xValues_@measurementName = @Html.Raw(Json.Serialize(xValues));

        var chartData_@measurementName = {
            labels: xValues_@measurementName,
                datasets: [{
                    label: '@measurementName',
                    data: @Html.Raw(Json.Serialize(dataValues)),
                    borderColor: '@randomColor',
                    fill: false
                }]
        };

        new Chart("@("myChart_" + measurementName)", {
            type: "line",
            data: chartData_@measurementName,
            options: {
            legend: { display: true },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Treatment Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            }
        }
                });
    </script>
}
